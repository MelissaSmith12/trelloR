---
title: "R API for Trello"
author: "Jakub Chromec"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
library(httr)
knitr::opts_chunk$set(comment = "#>", collapse = TRUE)
```

This document explains how to retrieve data from public and private Trello boards using `trelloR`.

Getting public data
-------------------

_NOTE. Right now, `trelloR` can only GET data from Trello API. Other requests (such as POST or PUT) are not implemented yet. Accessing data in private boards requires authorization, which you can read about in the **Getting private data** section._

The basic building block of Trello workflow is the board. It encapsulates a hierarchy of parent and child structures (or "resources"), such as teams, cards, labels, members and actions. Every resource in this hierarchy (including actions) has its unique ID. Some, like boards or cards have a URL which can be used as ID.

In order to obtain data related to a particular resource you need its ID or the ID of its parent structure. If you have it, you can call a function which performs a GET request and retrieves data. Here is an example of getting a card-related data from [Trello Development Roadmap](https://trello.com/b/nC8QJJoZ/trello-development-roadmap) (public board). Knowing its URL, we can acquire its ID and use it to retrieve 5 cards from it:

```{r}
library(trelloR)
url = "https://trello.com/b/nC8QJJoZ/trello-development-roadmap"
idb = get_id_board(url = url)
cards = get_board_cards(idb, limit = 5)
```

If the request is processed without errors, a JSON response is received. `trelloR` will attempt to parse it into a `data.frame` which works well with available fetching functions. If you send your own request (you will see how later on), this conversion is not guaranteed and may return a `list` instead.

Typically, the response will contain multiple columns including resource ID, name and other data, such as attachments or preferences. Since the ID of child elements is included in the response, you can use that to work your way down the hierarchy until you reach the desired level.

####Function naming scheme

Knowing which level of the hierarchy you want to get data from is useful because it makes easy to guess tfunction names: If you want cards from a particular board, call `get_board_cards`. If you need list of people assigned to a card, call `get_card_members`. The parent level is always followed by the child level, and the `get_` prefix comes in the front. For an overview of available functions, call `?get_board`, `?get_card`, `?get_team`, `?get_member` and `?get_id`.

###Custom requests with `trello_get`
Every function in this package (except for `trello_get_token`) is just a wrapper around `trello_get`. If you lack a particular data-fetching option, you can call it directly, or you can define a new function by providing some default values.

This example creates a function that fetches all updates made in a given card (it uses a filter value because updates are a type of action, and we don't want to retrieve all actions):

```{r}
get_card_updates = function(id, ...) {
    trello_get(parent = "card", child  = "actions", id = id, filter = "updateCard", ...)
}
```

Function like this can be called the usual way, supplying a card ID:

```{r}
idc = cards$id[1]
card_updates = get_card_updates(idc, limit = 5)
```

For detailed list of all possible queries, consult the [Trello API reference](https://developers.trello.com/advanced-reference).

###Additional arguments
We have already seen an additional argument in the previous example: a `filter`. However, there are more arguments that `trello_get` accepts:

```{r}
args(trello_get)
```

You can supply a:

* `token` useful for accessing private boards (see the __Getting private data__)
* `limit` defaults to 1000 results, which is also the maximum value for single request
* `query` by providing a list of key-value pairs, such as `query = list(key1 = "value1", key2 = "value2")`. Read `?httr::GET` for details. Setting `filter = "updateCard` and `limit=10` is the equivalent of `query = list(filter = "updateCard", limit = 10)`; if you need more info about what keys and values are available for the query prameters, visit the [Trello API reference](https://developers.trello.com/advanced-reference)
* `paging` useful for requests returning more than 1000 results; it breaks the request down into smaller pieces, each returning no more than 1000 results
* `bind.rows` binds all the pages into a single `data.frame`

If `bind.rows = FALSE`, the result will be a `list` with as many elements as there were pages. This can be a useful workaround in situations when the responses are not perfectly formatted and make `dplyr::bind_rows` fail.

When calling `trello_get()` directly, you have an option to either specify `parent` and `child` or you can provide the whole URL as a character vector of length 1.

```{r}
board_comments = trello_get(parent = "board", child = "actions", id = idb,
                            filter = "commentCard", limit = 5)
```

###Error handling
When a request fails because of client-side or server-side error, the error code is reprinted in the console. Additional server messages are also included to make debugging easier.

```{r}
tryCatch(
    expr  = get_card_actions(id = "123"),
    error = function(e) {
        print(e$message)})
```


Getting private data
----------------------

Access to private boards requires authorization. This is done by registering an "app" that uses a secure token to communicate with Trello API. Supplying the token to data-fetching functions will allow you to retrieve data from private boards - on the condition that the user who authorized the app has the right to access them.

To create a token, **login** to Trello and visit the [Developer Start Page](https://developers.trello.com/get-started/start-building#connect). There you can get your developer credentials, i.e. your "key" and "secret". Then, call the `trello_get_token()` function to create a token for your project. This will also trigger first-time authorization in the browser (you only have to do it once):

```r
my_token = trello_get_token(your_key, your_secret)
```

You will also be offered an option to store the authentication data in your working directory, in a hidden `'.httr-oauth'` file.

**NOTE.** Make sure you keep your credentials in a **safe, non-shared** location.

###Using the token to retrieve private data

One thing you can do immediately after obtaining a token is to get an overview of all your boards, by the `get_my_boards()` function. It accepts the token as its only argument and returns a `data.frame` with board names and IDs related to the user who authorize the app.

Next, you can just use the `get_` functions to retrieve data as before, supplying the token as the named argument (`token = your_token`).

#####Disclaimer
`trelloR` is not affiliated, associated, authorized, endorsed by or in any way officially connected to Trello, Inc. (www.trello.com).

#####Build with

```{r}
sessionInfo()
```
